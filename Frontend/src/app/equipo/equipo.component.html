<app-header></app-header>

<div *ngIf="sinEquipo" class="sin-equipo">
  <h2>‚ö†Ô∏è Todav√≠a no tienes ning√∫n equipo asignado</h2>
  <p>Contacta con tu entrenador o con el administrador del club.</p>
</div>

<div *ngIf="!sinEquipo"><div class="equipo-wrapper" *ngIf="!loading && equipo && !sinEquipo; else loadingTpl">

  <!-- =========================
       CABECERA
  ========================== -->
  <div class="equipo-header">
    <div class="left">
      <img
        *ngIf="equipo.club.escudo"
        [src]="'http://localhost:3000' + equipo.club.escudo"
        class="escudo"
      />
      <div class="texto">
        <h1>{{ equipo.nombre }}</h1>
        <p>{{ equipo.club.nombre }}</p>
        <p>{{ equipo.categoria.nombre }} ¬∑ {{ equipo.temporada.nombre }}</p>
      </div>
    </div>

    <!-- VOLVER AL CLUB ‚Üí SOLO ADMIN -->
    <button
      class="volver"
      *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
      (click)="volverAlClub()">
      ‚Üê Volver al club
    </button>
  </div>

  <!-- =========================
       GRID PRINCIPAL
  ========================== -->
  <div class="grid-panel">

    <!-- =========================
         ENTRENADORES
    ========================== -->
    <div class="panel-card entrenador-card">
      <h3>Entrenadores ({{ equipo.entrenadores?.length || 0 }})</h3>

      <div *ngIf="equipo.entrenadores?.length; else noCoaches">
        <div class="jug-item" *ngFor="let e of equipo.entrenadores">
          <span class="round">
            <img *ngIf="e.foto" [src]="'http://localhost:3000' + e.foto" />
            <span *ngIf="!e.foto">{{ e.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ e.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ e.DNI }}</span>
              <span class="meta-item" *ngIf="e.telefono">Tel: {{ e.telefono }}</span>
              <span class="meta-item email" *ngIf="e.email">{{ e.email }}</span>
            </p>
          </div>

          <!-- QUITAR ENTRENADOR ‚Üí SOLO ADMIN -->
          <button
            class="delete"
            *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
            (click)="eliminarEntrenador(e.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <ng-template #noCoaches>
        <p class="empty">No hay entrenadores asignados</p>
      </ng-template>

      <!-- A√ëADIR ENTRENADOR ‚Üí SOLO ADMIN -->
      <button
        class="cambiar primary"
        *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
        (click)="abrirModalEntrenadorEquipo()">
        A√±adir entrenador
      </button>
    </div>

    <!-- =========================
         JUGADORES
    ========================== -->

    <!-- ADMIN (con drag & drop) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
      (drop)="onDropJugador($event)"
      (dragover)="allowDrop($event)">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list" *ngIf="equipo.jugadores.length; else noPlayers">
        <div
          class="jug-item"
          *ngFor="let j of equipo.jugadores"
          draggable="true"
          (dragstart)="dragJugador($event, j.DNI)">

          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>

          <!-- QUITAR JUGADOR ‚Üí ADMIN -->
          <button
            class="delete"
            (click)="eliminarJugador(j.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <ng-template #noPlayers>
        <p class="empty">No hay jugadores en este equipo.</p>
      </ng-template>

      <!-- A√ëADIR JUGADORES ‚Üí ADMIN -->
      <button
        class="cambiar primary"
        (click)="abrirModalAddJugadores()">
        A√±adir jugadores
      </button>
    </div>

    <!-- ENTRENADOR (sin drag & drop) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('entrenador')">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list" *ngIf="equipo.jugadores.length">
        <div class="jug-item" *ngFor="let j of equipo.jugadores">

          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>

          <!-- QUITAR JUGADOR ‚Üí ENTRENADOR -->
          <button
            class="delete"
            (click)="eliminarJugador(j.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <!-- A√ëADIR JUGADORES ‚Üí ENTRENADOR -->
      <button
        class="cambiar primary"
        (click)="abrirModalAddJugadores()">
        A√±adir jugadores
      </button>
    </div>

    <!-- JUGADOR (solo lectura) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('jugador')">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list">
        <div class="jug-item" *ngFor="let j of equipo.jugadores">
          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>
        </div>
      </div>
    </div>

  </div>

<!-- =========================
       GESTI√ìN DEPORTIVA
  ========================== -->
  <div class="panel-card">
    <h3>Gesti√≥n deportiva</h3>

    <div *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club') || authService.hasRole('entrenador')">
      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'eventos']">
        üìÖ Eventos del equipo
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'convocatorias']">
        üì£ Convocatorias
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'calendario']">
        üóìÔ∏è Calendario del equipo
      </button>
    </div>

    <div *ngIf="authService.hasRole('jugador')">
      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'convocatorias']">
        üì£ Ver convocatorias
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'calendario']">
        üóìÔ∏è Ver calendario
      </button>
    </div>
  </div>

</div> <!-- üëà ESTE DIV FALTABA -->

<ng-template #loadingTpl>
  <p class="loading">Cargando equipo...</p>
</ng-template>

<!-- =========================
     CONVOCATORIAS
========================== -->
<div class="panel-card" style="margin-top: 18px;">
  <div class="panel-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Convocatorias</h2>

    <div style="display:flex; gap:10px; align-items:center;">
      <button
        class="cambiar primary"
        *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
        (click)="abrirModalCrearConvocatoria()">
        + Nueva convocatoria
      </button>
    </div>
  </div>

  <p *ngIf="loadingConvocatorias">Cargando convocatorias...</p>
  <p *ngIf="!loadingConvocatorias && convocatorias.length === 0">No hay convocatorias todav√≠a.</p>

  <div class="lista-convocatorias" *ngIf="!loadingConvocatorias && convocatorias.length > 0">
    <div class="conv-card" *ngFor="let c of convocatorias">
      <div class="conv-main">
        <div class="conv-title">
          <b>{{ c.fecha_partido | date:'dd/MM/yyyy' }}</b>
          <span *ngIf="c.rival"> ¬∑ vs {{ c.rival }}</span>
        </div>

        <div class="conv-meta">
          <span>Inicio: {{ c.hora_inicio }}</span>
          <span>Quedada: {{ c.hora_quedada }}</span>
          <span *ngIf="c.lugar">Lugar: {{ c.lugar }}</span>
          <span>L√≠mite: {{ c.fecha_limite_confirmacion | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>

        <div class="conv-actions" *ngIf="authService.hasRole('jugador')">

          <span class="estado-badge no-invitado" *ngIf="!estaInvitado(c)">
             No convocado
          </span>

          <ng-container *ngIf="estaInvitado(c)">
            <span class="estado-badge cerrada" *ngIf="convocatoriaCerrada(c)">
              Convocatoria cerrada ¬∑ 
              <span class="estado-text">
                {{ estadoJugador(c) === 'confirmado' ? 'Confirmado' : (estadoJugador(c) === 'rechazado' ? 'Rechazado' : 'Sin respuesta') }}
              </span>
            </span>

            <ng-container *ngIf="!convocatoriaCerrada(c)">
              <span class="estado-badge" *ngIf="estadoJugador(c) && estadoJugador(c) !== 'pendiente'" [ngClass]="estadoJugador(c)">
                {{ estadoJugador(c) | uppercase }}
              </span>

              <ng-container *ngIf="!estadoJugador(c) || estadoJugador(c) === 'pendiente'">
                <span class="estado">Estado: <b>pendiente</b></span>
                <button class="cambiar" (click)="responderConvocatoria(c, 'confirmado')"> Confirmar</button>
                <button class="rechazar" (click)="responderConvocatoria(c, 'rechazado')"> Rechazar</button>
              </ng-container>
            </ng-container>
          </ng-container>
        </div>

        <div class="conv-actions" *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')">
          <span class="estado">
            Convocados: <b>{{ c.jugadores?.length || 0 }}</b>
            ¬∑ ‚úÖ {{ contarPorEstado(c, 'confirmado') }}
            ¬∑ ‚ùå {{ contarPorEstado(c, 'rechazado') }}
            ¬∑ ‚è≥ {{ contarPorEstado(c, 'pendiente') }}
          </span>

          <button
          class="cambiar"
          *ngIf="!convocatoriaCerrada(c)"
          (click)="enviarRecordatorio(c)">
          üîî Enviar recordatorio
        </button>
        
        <!-- INDICADOR CERRADA -->
        <span
          class="estado-badge cerrada"
          *ngIf="convocatoriaCerrada(c)">
          Convocatoria cerrada
        </span>
        </div>

        <details class="conv-details">
          <summary>Ver convocados</summary>
          <div class="convocados">
            <div class="conv-j" *ngFor="let j of c.jugadores">
              <span>{{ j.nombre }} <span style="color:#777;">({{ j.DNI }})</span></span>
              <span class="pill" [ngClass]="j.estado">{{ estadoLabel(j.estado) }}</span>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>
<!-- =========================
     EVENTOS
========================== -->
<div class="panel-card" style="margin-top: 18px;">
  <div class="panel-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Eventos</h2>

    <div style="display:flex; gap:10px; align-items:center;">
      <button
        class="cambiar primary"
        *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club') || authService.hasRole('entrenador')"
        (click)="abrirModalCrearEvento()">
        + Nuevo evento
      </button>
    </div>
  </div>

  <p *ngIf="loadingEventos">Cargando eventos...</p>
  <p *ngIf="!loadingEventos && eventos.length === 0">No hay eventos todav√≠a.</p>

  <div class="lista-eventos" *ngIf="!loadingEventos && eventos.length > 0">
    <div class="evento" *ngFor="let e of eventos" [class.evento-pasado]="esEventoPasado(e)">

      <div class="evento-main">
        <div class="evento-title">
          <b>{{ e.titulo }}</b>
        </div>

        <div class="evento-meta">
          <span *ngIf="e.descripcion">Descripci√≥n: {{ e.descripcion }}</span>
          <span>Inicio: {{ e.fecha_inicio | date:'short' }}</span>
          <span>Fin: {{ e.fecha_fin | date:'short' }}</span>
          <span>Tipo: {{ e.tipo | titlecase }}</span>
        </div>

        <!-- =========================
             RESPUESTA JUGADOR
        ========================== -->
        <div class="evento-actions" *ngIf="e.requiere_confirmacion && authService.hasRole('jugador')">

          <span class="estado-badge no-invitado" *ngIf="!estaInvitado(e)">
             No requerido
          </span>

          <ng-container *ngIf="estaInvitado(e)">
            <span class="estado-badge" *ngIf="estadoJugadorEvento(e) && estadoJugadorEvento(e) !== 'pendiente'" [ngClass]="estadoJugadorEvento(e)">
              {{ estadoJugadorEvento(e) | uppercase }}
            </span>

            <ng-container *ngIf="!estadoJugadorEvento(e) || estadoJugadorEvento(e) === 'pendiente'">
              <span class="estado">Estado: <b>pendiente</b></span>
              <button class="cambiar" (click)="responderEvento(e, 'confirmado')"> Confirmar</button>
              <button class="rechazar" (click)="responderEvento(e, 'rechazado')"> Rechazar</button>
            </ng-container>
          </ng-container>
        </div>

        <!-- =========================
             VISTA ADMIN / ENTRENADOR
        ========================== -->
        <div class="evento-actions" *ngIf="authService.hasRole('admin_plataforma') || authService.hasRole('admin_club') || authService.hasRole('entrenador')">
          <span class="estado" *ngIf="e.requiere_confirmacion">
            Confirmaciones:
            ‚úÖ {{ contarPorEstadoEvento(e, 'confirmado') }}
            ¬∑ ‚ùå {{ contarPorEstadoEvento(e, 'rechazado') }}
            ¬∑ ‚è≥ {{ contarPorEstadoEvento(e, 'pendiente') }}
          </span>

          <button class="cambiar" *ngIf="!esEventoPasado(e)" (click)="enviarRecordatorioEvento(e)">
            üîî Enviar recordatorio
          </button>

          <button class="delete" (click)="eliminarEvento(e)">üóë Eliminar</button>

          <span class="estado-badge cerrada" *ngIf="esEventoPasado(e)">
            Evento finalizado
          </span>
        </div>

        <!-- =========================
             DETALLES DE JUGADORES
        ========================== -->
        <details class="conv-details" *ngIf="e.requiere_confirmacion">
          <summary>Ver jugadores</summary>
          <div class="convocados">
            <div class="conv-j" *ngFor="let j of e.jugadores">
              <span>{{ j.nombre }} <span style="color:#777;">({{ j.DNI }})</span></span>
              <span class="pill" [ngClass]="j.estado">{{ estadoLabel(j.estado) }}</span>
            </div>
          </div>
        </details>

      </div>
    </div>
  </div>
</div>
</div>



