<app-header></app-header>

<div class="equipo-wrapper" *ngIf="!loading && equipo; else loadingTpl">

  <!-- =========================
       CABECERA
  ========================== -->
  <div class="equipo-header">
    <div class="left">
      <img
        *ngIf="equipo.club.escudo"
        [src]="'http://localhost:3000' + equipo.club.escudo"
        class="escudo"
      />
      <div class="texto">
        <h1>{{ equipo.nombre }}</h1>
        <p>{{ equipo.club.nombre }}</p>
        <p>{{ equipo.categoria }} ¬∑ {{ equipo.temporada }}</p>
      </div>
    </div>

    <!-- VOLVER AL CLUB ‚Üí SOLO ADMIN -->
    <button
      class="volver"
      *ngIf="authService.hasRole('admin')"
      (click)="volverAlClub()">
      ‚Üê Volver al club
    </button>
  </div>

  <!-- =========================
       GRID PRINCIPAL
  ========================== -->
  <div class="grid-panel">

    <!-- =========================
         ENTRENADORES
    ========================== -->
    <div class="panel-card entrenador-card">
      <h3>Entrenadores ({{ equipo.entrenadores?.length || 0 }})</h3>

      <div *ngIf="equipo.entrenadores?.length; else noCoaches">
        <div class="jug-item" *ngFor="let e of equipo.entrenadores">
          <span class="round">
            <img *ngIf="e.foto" [src]="'http://localhost:3000' + e.foto" />
            <span *ngIf="!e.foto">{{ e.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ e.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ e.DNI }}</span>
              <span class="meta-item" *ngIf="e.telefono">Tel: {{ e.telefono }}</span>
              <span class="meta-item email" *ngIf="e.email">{{ e.email }}</span>
            </p>
          </div>

          <!-- QUITAR ENTRENADOR ‚Üí SOLO ADMIN -->
          <button
            class="delete"
            *ngIf="authService.hasRole('admin')"
            (click)="eliminarEntrenador(e.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <ng-template #noCoaches>
        <p class="empty">No hay entrenadores asignados</p>
      </ng-template>

      <!-- A√ëADIR ENTRENADOR ‚Üí SOLO ADMIN -->
      <button
        class="cambiar primary"
        *ngIf="authService.hasRole('admin')"
        (click)="abrirModalEntrenadorEquipo()">
        A√±adir entrenador
      </button>
    </div>

    <!-- =========================
         JUGADORES
    ========================== -->

    <!-- ADMIN (con drag & drop) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('admin')"
      (drop)="onDropJugador($event)"
      (dragover)="allowDrop($event)">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list" *ngIf="equipo.jugadores.length; else noPlayers">
        <div
          class="jug-item"
          *ngFor="let j of equipo.jugadores"
          draggable="true"
          (dragstart)="dragJugador($event, j.DNI)">

          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>

          <!-- QUITAR JUGADOR ‚Üí ADMIN -->
          <button
            class="delete"
            (click)="eliminarJugador(j.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <ng-template #noPlayers>
        <p class="empty">No hay jugadores en este equipo.</p>
      </ng-template>

      <!-- A√ëADIR JUGADORES ‚Üí ADMIN -->
      <button
        class="cambiar primary"
        (click)="abrirModalAddJugadores()">
        A√±adir jugadores
      </button>
    </div>

    <!-- ENTRENADOR (sin drag & drop) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('entrenador')">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list" *ngIf="equipo.jugadores.length">
        <div class="jug-item" *ngFor="let j of equipo.jugadores">

          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>

          <!-- QUITAR JUGADOR ‚Üí ENTRENADOR -->
          <button
            class="delete"
            (click)="eliminarJugador(j.DNI)">
            ‚úï
          </button>
        </div>
      </div>

      <!-- A√ëADIR JUGADORES ‚Üí ENTRENADOR -->
      <button
        class="cambiar primary"
        (click)="abrirModalAddJugadores()">
        A√±adir jugadores
      </button>
    </div>

    <!-- JUGADOR (solo lectura) -->
    <div
      class="panel-card jugadores-card"
      *ngIf="authService.hasRole('jugador')">

      <h3>Jugadores ({{ equipo.jugadores.length }})</h3>

      <div class="jug-list">
        <div class="jug-item" *ngFor="let j of equipo.jugadores">
          <span class="round">
            <img *ngIf="j.foto" [src]="'http://localhost:3000' + j.foto" />
            <span *ngIf="!j.foto">{{ j.nombre[0] | uppercase }}</span>
          </span>

          <div>
            <h4>{{ j.nombre }}</h4>
            <p class="meta">
              <span class="meta-item">DNI: {{ j.DNI }}</span>
              <span class="meta-item" *ngIf="j.telefono">Tel: {{ j.telefono }}</span>
              <span class="meta-item email" *ngIf="j.email">{{ j.email }}</span>
            </p>
          </div>
        </div>
      </div>
    </div>

  </div>

<!-- =========================
       GESTI√ìN DEPORTIVA
  ========================== -->
  <div class="panel-card">
    <h3>Gesti√≥n deportiva</h3>

    <div *ngIf="authService.hasRole('admin') || authService.hasRole('entrenador')">
      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'eventos']">
        üìÖ Eventos del equipo
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'convocatorias']">
        üì£ Convocatorias
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'calendario']">
        üóìÔ∏è Calendario del equipo
      </button>
    </div>

    <div *ngIf="authService.hasRole('jugador')">
      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'convocatorias']">
        üì£ Ver convocatorias
      </button>

      <button class="action-btn" [routerLink]="['/equipo', equipo.id, 'calendario']">
        üóìÔ∏è Ver calendario
      </button>
    </div>
  </div>

</div> <!-- üëà ESTE DIV FALTABA -->

<ng-template #loadingTpl>
  <p class="loading">Cargando equipo...</p>
</ng-template>

<!-- =========================
     CONVOCATORIAS
========================== -->
<div class="panel-card" style="margin-top: 18px;">
  <div class="panel-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Convocatorias</h2>

    <div style="display:flex; gap:10px; align-items:center;">
      <button
        class="cambiar primary"
        *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin')"
        (click)="abrirModalCrearConvocatoria()">
        + Nueva convocatoria
      </button>
    </div>
  </div>

  <p *ngIf="loadingConvocatorias">Cargando convocatorias...</p>
  <p *ngIf="!loadingConvocatorias && convocatorias.length === 0">No hay convocatorias todav√≠a.</p>

  <div class="lista-convocatorias" *ngIf="!loadingConvocatorias && convocatorias.length > 0">
    <div class="conv-card" *ngFor="let c of convocatorias">
      <div class="conv-main">
        <div class="conv-title">
          <b>{{ c.fecha_partido | date:'dd/MM/yyyy' }}</b>
          <span *ngIf="c.rival"> ¬∑ vs {{ c.rival }}</span>
        </div>

        <div class="conv-meta">
          <span>Inicio: {{ c.hora_inicio }}</span>
          <span>Quedada: {{ c.hora_quedada }}</span>
          <span *ngIf="c.lugar">Lugar: {{ c.lugar }}</span>
          <span>L√≠mite: {{ c.fecha_limite_confirmacion | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>

        <div class="conv-actions" *ngIf="authService.hasRole('jugador')">

          <!-- ESTADO DESTACADO (SI YA RESPONDI√ì) -->
          <span
            class="estado-badge"
            *ngIf="estadoJugador(c) && estadoJugador(c) !== 'pendiente'"
            [ngClass]="estadoJugador(c)">
            {{ estadoJugador(c) }}
          </span>
        
          <!-- BOTONES SOLO SI EST√Å PENDIENTE -->
          <ng-container *ngIf="!estadoJugador(c) || estadoJugador(c) === 'pendiente'">
            <span class="estado">
              Estado: <b>pendiente</b>
            </span>
        
            <button class="cambiar" (click)="responderConvocatoria(c, 'confirmado')">
              ‚úÖ Confirmar
            </button>
        
            <button class="delete" (click)="responderConvocatoria(c, 'rechazado')">
              ‚ùå Rechazar
            </button>
          </ng-container>
        
        </div>

        <div class="conv-actions" *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin')">
          <span class="estado">
            Convocados: <b>{{ c.jugadores?.length || 0 }}</b>
            ¬∑ ‚úÖ {{ contarPorEstado(c, 'confirmado') }}
            ¬∑ ‚ùå {{ contarPorEstado(c, 'rechazado') }}
            ¬∑ ‚è≥ {{ contarPorEstado(c, 'pendiente') }}
          </span>

          <button class="cambiar" (click)="enviarRecordatorio(c)">üîî Enviar recordatorio</button>
        </div>

        <details class="conv-details">
          <summary>Ver convocados</summary>
          <div class="convocados">
            <div class="conv-j" *ngFor="let j of c.jugadores">
              <span>{{ j.nombre }} <span style="color:#777;">({{ j.DNI }})</span></span>
              <span class="pill" [ngClass]="j.estado">{{ j.estado }}</span>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>
