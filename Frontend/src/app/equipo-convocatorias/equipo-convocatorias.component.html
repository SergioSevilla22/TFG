<app-header></app-header>

<div class="equipo-layout" *ngIf="!sinEquipo">
  <app-sidebar-equipo
    [equipo]="equipo"
    [equipoId]="equipoId"
    activo="convocatorias">
  </app-sidebar-equipo>

  <main class="equipo-content">
    <div class="panel-card main-panel">
      
      <div class="panel-header">
        <div class="header-info">
          <h2>Convocatorias</h2>
          <p class="subtitle">Gesti√≥n de citaciones y asistencia para partidos</p>
        </div>

        <button
          class="btn-primary"
          *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')"
          (click)="abrirModalCrearConvocatoria()">
          <span class="plus-icon">+</span> Nueva convocatoria
        </button>
      </div>

      <div class="status-container" *ngIf="loadingConvocatorias">
        <div class="spinner"></div>
        <p>Cargando convocatorias...</p>
      </div>
      
      <div *ngIf="!loadingConvocatorias && convocatorias.length === 0" class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>Sin convocatorias</h3>
        <p>No se han publicado convocatorias para los pr√≥ximos encuentros.</p>
      </div>

      <div class="lista-convocatorias" *ngIf="!loadingConvocatorias && convocatorias.length > 0">
        <div class="conv-card" *ngFor="let c of convocatorias" [class.cerrada]="convocatoriaCerrada(c)">
          
          <div class="conv-header-row">
            <div class="match-info">
              <div class="match-date">
                <span class="day">{{ c.fecha_partido | date:'dd' }}</span>
                <span class="month">{{ c.fecha_partido | date:'MMM' }}</span>
              </div>
              <div class="match-details">
                <h3 class="rival-name">{{ c.rival ? 'vs ' + c.rival : 'Partido de Entrenamiento' }}</h3>
                <div class="match-meta">
                  <span class="location" *ngIf="c.lugar">
                    <span class="geo-icon">üó∫Ô∏è</span> {{ c.lugar }}
                  </span>
                  <span class="limit-tag" [class.danger]="convocatoriaCerrada(c)">
                    ‚è∞ L√≠mite: {{ c.fecha_limite_confirmacion | date:'dd/MM HH:mm' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="time-slots">
              <div class="time-box">
                <span class="label">Quedada</span>
                <span class="value">{{ c.hora_quedada }}</span>
              </div>
              <div class="time-box highlight">
                <span class="label">Inicio</span>
                <span class="value">{{ c.hora_inicio }}</span>
              </div>
            </div>
          </div>

          <div class="conv-body">
            <div class="section-player" *ngIf="authService.hasRole('jugador')">
              <div class="player-status-bar" *ngIf="!estaInvitado(c)">
                <span class="status-pill gray">No convocado</span>
              </div>

              <div class="player-status-bar" *ngIf="estaInvitado(c)">
                <div class="decision-zone" *ngIf="!convocatoriaCerrada(c)">
                  <ng-container *ngIf="!estadoJugador(c) || estadoJugador(c) === 'pendiente'">
                    <span class="pending-text">¬øConfirmas tu asistencia?</span>
                    <div class="btn-group">
                      <button class="btn-action confirm" (click)="responderConvocatoria(c, 'confirmado')">Confirmar ‚úì</button>
                      <button class="btn-action reject" (click)="abrirModalMotivoConvocatoria(c)">Rechazar ‚úï</button>
                    </div>
                  </ng-container>
                  
                  <div class="already-responded" *ngIf="estadoJugador(c) && estadoJugador(c) !== 'pendiente'">
                    <span class="status-pill" [ngClass]="estadoJugador(c)">
                      Has respondido: {{ estadoJugador(c) | uppercase }}
                    </span>
                  </div>
                </div>

                <div class="closed-zone" *ngIf="convocatoriaCerrada(c)">
                  <span class="status-pill closed">CONVOCATORIA FINALIZADA</span>
                  <span class="final-answer" *ngIf="estaInvitado(c)">
                    Tu estado: <b>{{ estadoJugador(c) | titlecase }}</b>
                  </span>
                </div>
              </div>
            </div>

            <div class="section-admin" *ngIf="authService.hasRole('entrenador') || authService.hasRole('admin_plataforma') || authService.hasRole('admin_club')">
              <div class="stats-pills">
                <span class="pill total">üë• <b>{{ c.jugadores?.length || 0 }}</b></span>
                <span class="pill confirm">‚úì <b>{{ contarPorEstado(c, 'confirmado') }}</b></span>
                <span class="pill reject">‚úï <b>{{ contarPorEstado(c, 'rechazado') }}</b></span>
                <span class="pill pending">? <b>{{ contarPorEstado(c, 'pendiente') }}</b></span>
              </div>

              <div class="admin-actions">
                <button class="btn-icon reminder" *ngIf="!convocatoriaCerrada(c)" (click)="enviarRecordatorio(c)" matTooltip="Enviar recordatorio">üîî</button>
                <button class="btn-icon delete" matTooltip="Eliminar" >üóë</button>
                <button
                class="btn-icon edit"
                [disabled]="convocatoriaCerrada(c)"
                [matTooltip]="convocatoriaCerrada(c) 
                  ? 'No se puede editar porque ya ha finalizado' 
                  : 'Editar convocatoria'"
                (click)="abrirEditarConvocatoria(c)">
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon stats"
                [disabled]="!convocatoriaCerrada(c)"
                [matTooltip]="convocatoriaCerrada(c) 
                  ? 'Cargar estad√≠sticas del partido' 
                  : 'Las estad√≠sticas se pueden cargar una vez que la convocatoria ha finalizado'"
                (click)="abrirModalEstadisticas(c)">
                üìä
              </button>
              </div>
            </div>
          </div>

          <details class="conv-players-list">
            <summary>
              <span class="summary-content">
                Ver lista de convocados 
                <span class="count-tag">{{ c.jugadores?.length }}</span>
              </span>
            </summary>
            <div class="players-grid">
              <div class="player-item" *ngFor="let j of c.jugadores">
                <div class="player-info">
                  <span class="player-name">{{ j.nombre }}</span>
                  <span class="player-dni">{{ j.DNI }}</span>
                </div>
                <div class="player-status">
                  <span class="mini-pill" [ngClass]="j.estado">{{ estadoLabel(j.estado) }}</span>
                  <span class="reason" *ngIf="j.motivo" [title]="j.motivo">üí¨</span>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>
    </div>
  </main>
</div>